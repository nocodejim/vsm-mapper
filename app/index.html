<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Value Stream Map Mermaid Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* General body and layout styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter as a common, clean font */
        }
        .input-group {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid #e2e8f0; /* border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
            position: relative; /* For positioning the insert button */
            background-color: #f9fafb; /* bg-gray-50 slightly different from body for contrast */
        }
        .input-group label, .title-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500; /* medium */
            color: #374151; /* text-gray-700 for better contrast */
        }
        .input-group input, .title-group input {
            width: 100%;
            padding: 0.75rem; /* Increased padding for better touch targets */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-sizing: border-box;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-group input:focus, .title-group input:focus {
            border-color: #2563eb; /* focus:border-blue-500 */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); /* focus:ring-blue-200 focus:ring-opacity-50 */
            outline: none;
        }
        .title-group { margin-bottom: 1.5rem; }

        /* Button styling */
        .btn { /* Common button class */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            display: inline-flex; /* For aligning icon and text if any */
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            transform: translateY(-1px); /* Slight lift on hover */
        }
        .btn:active {
            transform: translateY(0px); /* Press down effect */
        }

        .remove-btn { 
            background-color: #ef4444; /* bg-red-500 */ 
            margin-left: 0.5rem; 
            padding: 0.375rem 0.625rem; /* Match + button padding */
            font-size: 1rem; /* Match + button size */
        }
        .remove-btn:hover { background-color: #dc2626; /* bg-red-600 */ }

        .insert-btn-before {
            background-color: #3b82f6; /* bg-blue-500 */
            padding: 0.375rem 0.625rem; /* Slightly smaller for an icon-like button */
            font-size: 1rem; /* Make the '+' larger */
        }
        .insert-btn-before:hover { background-color: #2563eb; /* bg-blue-600 */ }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        .step-header h3 {
            color: #1f2937; /* text-gray-800 */
        }
        .step-header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Space between insert and remove buttons */
        }

        .add-btn-end {
             background-color: #10b981; /* bg-emerald-500 */
        }
        .add-btn-end:hover { background-color: #059669; /* bg-emerald-600 */ }

        .generate-btn {
             background-color: #6366f1; /* bg-indigo-500 */
             padding: 0.75rem 1.5rem;
             font-size: 1rem;
             font-weight: 600;
             margin-top: 1.5rem;
             width: 100%;
        }
        .generate-btn:hover { background-color: #4f46e5; /* bg-indigo-600 */ }

        #mermaidOutput {
            font-family: 'Fira Code', 'Source Code Pro', monospace; /* Monospaced font for code */
            white-space: pre;
            background-color: #f3f4f6; /* bg-gray-100 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 1rem;
            margin-top: 1.5rem;
            min-height: 200px;
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
            line-height: 1.6;
        }
         .output-actions { margin-top: 0.75rem; display: flex; gap: 0.5rem; }
         .output-actions button { /* Inherits .btn styling, specific overrides below */
            font-weight: 500;
         }
         .output-actions button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
         #copyButton { background-color: #6b7280; /* bg-gray-500 */ }
         #copyButton:hover:not(:disabled) { background-color: #4b5563; /* bg-gray-600 */ }
         #saveMarkdownBtn { background-color: #0ea5e9; /* bg-sky-500 */ }
         #saveMarkdownBtn:hover:not(:disabled) { background-color: #0284c7; /* bg-sky-600 */ }

         footer {
             margin-top: 2rem;
             padding-top: 1rem;
             border-top: 1px solid #e5e7eb; /* border-gray-200 */
             font-size: 0.875rem; /* text-sm */
             color: #6b7280; /* text-gray-500 */
         }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans p-4 sm:p-8 flex flex-col min-h-screen">
    <div class="flex-grow max-w-3xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-xl w-full">
        <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">Value Stream Map Generator</h1>

        <form id="vsmForm">
            <div class="title-group">
                <label for="titleInput" class="text-gray-700">Diagram Title (Optional):</label>
                <input type="text" id="titleInput" name="titleInput" placeholder="e.g., New Feature Rollout Process">
            </div>

            <div id="stepsContainer" class="space-y-4">
                </div>

            <button type="button" id="addStepEndBtn" class="btn add-btn-end mt-6">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                    <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
                </svg>
                Add Step at End
            </button>

            <button type="submit" class="btn generate-btn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                  <path fill-rule="evenodd" d="M10 2c-1.717 0-3.415.224-5.002.65A1 1 0 003.5 2H3a1 1 0 00-1 1v1.252A9.966 9.966 0 001.65 8.002V10a1 1 0 00.348.752L4 12.348V16.5a1 1 0 001 1h1.252a9.966 9.966 0 003.096.35V18a1 1 0 001 1h.252L12 17.652V14a1 1 0 00-.348-.752L10 11.652V9.5A9.966 9.966 0 0011.95 6.4V5a1 1 0 00-1-1h-.252L9.5 2.348V2A1 1 0 009 1H5.748A9.966 9.966 0 0010 2zM8.5 4.002a1 1 0 00-1.414-.087L4.03 6.291A8.469 8.469 0 014.024 8H5.5a1 1 0 00.913-.587L8.5 4.002zM13.97 6.29A8.469 8.469 0 0114.5 8H16a1 1 0 00.707-1.707l-1.292-1.293A1 1 0 0013.97 6.29zM12 9.652a1 1 0 00.913.587H14.5a8.469 8.469 0 01-.53 1.708l-2.058-2.058A1 1 0 0012 9.652zm-2.587-.913a1 1 0 00-.913.587L6.45 11.385A8.469 8.469 0 016 9.676H7.05A1 1 0 008.5 8.002l.913-.587z" clip-rule="evenodd" />
                </svg>
                Generate Mermaid Code
            </button>
        </form>

        <div id="outputContainer" class="mt-8" style="display: none;">
            <h2 class="text-2xl font-semibold mb-3 text-gray-800">Generated Mermaid Code:</h2>
            <p class="text-sm text-gray-600 mb-3">Review the code below. You can copy it directly or save it as a formatted Markdown file.</p>
            <textarea id="mermaidOutput" readonly></textarea>
            <div class="output-actions mt-4">
                 <button id="copyButton" class="btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                      <path d="M7 3.5A1.5 1.5 0 018.5 2h3.879a1.5 1.5 0 011.06.44l3.122 3.121A1.5 1.5 0 0117 6.621V16.5a1.5 1.5 0 01-1.5 1.5h-7A1.5 1.5 0 017 16.5v-13z" />
                      <path d="M5 6.5A1.5 1.5 0 016.5 5h3V3.5a1.5 1.5 0 00-1.5-1.5h-3A1.5 1.5 0 002 3.5v10A1.5 1.5 0 003.5 15h3a.75.75 0 000-1.5h-3a.75.75 0 01-.75-.75v-10A.75.75 0 015 5.75V6.5z" />
                    </svg>
                    Copy Code
                </button>
                 <button id="saveMarkdownBtn" class="btn" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                      <path d="M10.75 2.75a.75.75 0 00-1.5 0V8.5h-5.75a.75.75 0 000 1.5h5.75V15.75a.75.75 0 001.5 0V9.999h5.75a.75.75 0 000-1.5h-5.75V2.75z" />
                      <path d="M3 9.5a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 9.5zM3 15.5a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 15.5zM3 3.5a.75.75 0 01.75-.75h12.5a.75.75 0 010 1.5H3.75A.75.75 0 013 3.5z" />
                    </svg>
                    Save as Markdown (.md)
                </button>
            </div>
             <p id="copyFeedback" class="text-sm text-green-600 mt-2" style="display: none;">Copied to clipboard!</p>
             <p id="saveFeedback" class="text-sm text-sky-600 mt-2" style="display: none;">Markdown file download initiated.</p>
        </div>
    </div> <footer class="max-w-3xl mx-auto w-full mt-auto px-6 pb-6 text-center sm:text-left">
         <div class="sm:flex sm:justify-between sm:items-center">
             <span class="block sm:inline mb-2 sm:mb-0">VSM Mapper Version: %%APP_VERSION%%</span>
             <span class="block sm:inline">Image Build: %%APP_VERSION%%</span>
         </div>
    </footer>

    <script>
        // --- SCRIPT START ---
        console.log("VSM Generator script loaded with insert step functionality.");

        // --- Global Variables ---
        let uniqueIdCounter = 0; // Used to generate unique IDs for step groups and their inputs

        // --- DOM Elements ---
        const form = document.getElementById('vsmForm');
        const titleInput = document.getElementById('titleInput');
        const stepsContainer = document.getElementById('stepsContainer');
        const addStepEndBtn = document.getElementById('addStepEndBtn');
        const outputContainer = document.getElementById('outputContainer');
        const mermaidOutput = document.getElementById('mermaidOutput');
        const copyButton = document.getElementById('copyButton');
        const saveMarkdownBtn = document.getElementById('saveMarkdownBtn');
        const copyFeedback = document.getElementById('copyFeedback');
        const saveFeedback = document.getElementById('saveFeedback');

        // --- Core Functions ---

        /**
         * Generates a unique ID string for step elements.
         * @returns {string} A unique ID.
         */
        function generateUniqueId() {
            uniqueIdCounter++;
            return `step_uid_${uniqueIdCounter}`; // More robust unique ID
        }

        /**
         * Creates and returns the DOM element for a new step group.
         * @param {string} uniqueStepId - The unique ID for this step group and its inputs.
         * @returns {HTMLElement} The new step group div element.
         */
        function createStepElement(uniqueStepId) {
            const stepDiv = document.createElement('div');
            stepDiv.classList.add('input-group');
            stepDiv.setAttribute('data-step-id', uniqueStepId);

            stepDiv.innerHTML = `
                <div class="step-header">
                    <h3 class="text-lg font-semibold text-gray-800">Step</h3> <div class="step-header-actions">
                        <button type="button" class="btn insert-btn-before" title="Add Step Before This Step" onclick="insertStepBefore(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
                        </button>
                        <button type="button" class="btn remove-btn" title="Remove This Step" onclick="removeStepElement(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                              <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <label for="stepName_${uniqueStepId}">Step Name:</label>
                <input type="text" id="stepName_${uniqueStepId}" name="stepName" required placeholder="e.g., Feature Request">

                <label for="processTime_${uniqueStepId}" class="mt-3">Process Time (e.g., '2 days'):</label>
                <input type="text" id="processTime_${uniqueStepId}" name="processTime" required placeholder="e.g., 2 days">

                <label for="waitTime_${uniqueStepId}" class="mt-3">Wait Time Before This Step:</label>
                <input type="text" id="waitTime_${uniqueStepId}" name="waitTime" placeholder="e.g., 5 days (leave blank if first)">
            `;
            return stepDiv;
        }

        /**
         * Adds a new step element to the DOM, either at the end or before a reference node.
         * @param {HTMLElement|null} referenceNode - If provided, the new step is inserted before this node. Otherwise, appended to stepsContainer.
         */
        function addNewStep(referenceNode = null) {
            const uniqueStepId = generateUniqueId();
            const newStepElement = createStepElement(uniqueStepId);

            if (referenceNode) {
                stepsContainer.insertBefore(newStepElement, referenceNode);
                console.log(`Inserted new step (ID: ${uniqueStepId}) before reference node.`);
            } else {
                stepsContainer.appendChild(newStepElement);
                console.log(`Appended new step (ID: ${uniqueStepId}) at the end.`);
            }
            updateDynamicUIElements(); // Crucial for re-numbering and button states
        }

        /**
         * Event handler for the "Add Step Before" button.
         * @param {HTMLElement} buttonElement - The "+" button that was clicked.
         */
        window.insertStepBefore = function(buttonElement) { // Make it globally accessible from inline onclick
            const currentStepGroup = buttonElement.closest('.input-group');
            if (currentStepGroup) {
                addNewStep(currentStepGroup);
            } else {
                console.error("Could not find parent step group for insertion.");
            }
        }

        /**
         * Event handler for the "Add Step at End" button.
         */
        function addStepAtEnd() {
            addNewStep(null); // Pass null to append to the end
        }

        /**
         * Event handler for removing a step element.
         * @param {HTMLElement} buttonElement - The "Remove" button that was clicked.
         */
        window.removeStepElement = function(buttonElement) { // Make it globally accessible
            const stepToRemove = buttonElement.closest('.input-group');
            if (stepToRemove) {
                const stepId = stepToRemove.getAttribute('data-step-id');
                stepsContainer.removeChild(stepToRemove);
                console.log(`Successfully removed step with ID: ${stepId}`);
                updateDynamicUIElements(); // Update numbering and buttons after removal
            } else {
                console.warn(`Could not find step group to remove.`);
            }
        }

        /**
         * Updates step numbers, "Remove" button visibility, and "Wait Time" placeholder for all steps.
         * This function is called after any addition, insertion, or removal of steps.
         */
        function updateDynamicUIElements() {
            const allStepGroups = stepsContainer.querySelectorAll('.input-group');
            allStepGroups.forEach((group, index) => {
                // Update Step Number Heading
                const heading = group.querySelector('.step-header h3');
                if (heading) {
                    heading.textContent = `Step ${index + 1}`;
                }

                // Manage "Remove" Button Visibility
                const removeBtn = group.querySelector('.remove-btn');
                if (removeBtn) {
                    // Only show remove button if there's more than one step
                    removeBtn.style.display = allStepGroups.length > 1 ? 'inline-flex' : 'none';
                }

                // Update Wait Time Placeholder and requirement for the first step
                const waitTimeInput = group.querySelector(`input[name="waitTime"]`);
                if (waitTimeInput) {
                    if (index === 0) {
                        waitTimeInput.placeholder = "e.g., 5 days (leave blank, it's the first step)";
                        // waitTimeInput.required = false; // First step wait time is optional
                    } else {
                        waitTimeInput.placeholder = "e.g., 5 days (required)";
                        // waitTimeInput.required = true; // Wait time is required for subsequent steps
                    }
                }
            });
            console.log("Dynamic UI elements updated (step numbers, remove buttons, placeholders).");
        }


        /**
         * Extracts and validates data from all step input fields in their current DOM order.
         * @returns {Array<Object>|null} An array of step objects if valid, otherwise null.
         */
        function getFormData() {
            console.log("Getting and validating form data...");
            const steps = [];
            const stepDivs = stepsContainer.querySelectorAll('.input-group');
            let isValid = true;

            if (stepDivs.length === 0) {
                alert("Please add at least one step to generate the map.");
                return null;
            }

            stepDivs.forEach((div, index) => {
                const uniqueStepId = div.getAttribute('data-step-id');
                const stepNumberForMsg = index + 1;

                const nameInput = div.querySelector(`#stepName_${uniqueStepId}`);
                const processTimeInput = div.querySelector(`#processTime_${uniqueStepId}`);
                const waitTimeInput = div.querySelector(`#waitTime_${uniqueStepId}`);

                let currentStepValid = true;
                if (!nameInput || !nameInput.value.trim()) {
                    alert(`Error: Step ${stepNumberForMsg} must have a name.`); isValid = false; currentStepValid = false;
                }
                if (!processTimeInput || !processTimeInput.value.trim()) {
                    alert(`Error: Step ${stepNumberForMsg} must have a process time.`); isValid = false; currentStepValid = false;
                }
                // Wait time is required for all steps *except* the very first one (index 0)
                if (index > 0 && (!waitTimeInput || !waitTimeInput.value.trim())) {
                    alert(`Error: Step ${stepNumberForMsg} must have a wait time (required for steps after the first).`); isValid = false; currentStepValid = false;
                }

                if (currentStepValid) {
                    steps.push({
                        id: `S${index}`, // Mermaid node ID based on current order
                        name: nameInput.value.trim(),
                        processTime: processTimeInput.value.trim(),
                        // Wait time is null if it's the first step AND the input is empty/whitespace
                        waitTime: (index === 0 && (!waitTimeInput.value || !waitTimeInput.value.trim())) ? null : waitTimeInput.value.trim()
                    });
                }
            });

            if (!isValid) {
                console.error("Form data validation failed."); return null;
            }
            console.log("Form data collected and validated:", steps);
            return steps;
        }

        /**
         * Generates the Mermaid diagram definition string from step data.
         * @param {Array<Object>} stepsData - Array of validated step objects.
         * @returns {string} The Mermaid diagram definition string.
         */
        function generateMermaidCode(stepsData) {
            console.log("Generating Mermaid code...");
            if (!stepsData || stepsData.length === 0) {
                return "graph LR\n    %% No steps entered";
            }
            let mermaidString = "graph LR\n";
            let totalProcessTime = 0, totalWaitTime = 0;

            // Define nodes and process flow links
            stepsData.forEach((step, i) => {
                const escapedName = step.name.replace(/"/g, '#quot;'); // Handle quotes in names
                mermaidString += `    ${step.id}["${escapedName}"]\n`;
                if (i < stepsData.length - 1) { // Link to next step if not the last
                    mermaidString += `    ${step.id} -->|${step.processTime}| ${stepsData[i+1].id}\n`;
                }
                const ptMatch = step.processTime.match(/\d+(\.\d+)?/); // Extract number
                if (ptMatch) totalProcessTime += parseFloat(ptMatch[0]);
            });

            // Add wait time links (between previous and current step)
            mermaidString += "\n    %% Add wait times\n";
            for (let i = 1; i < stepsData.length; i++) { // Start from the second step
                const step = stepsData[i];
                const prevStep = stepsData[i-1];
                if (step.waitTime) { // Wait time should exist for steps > 0 due to validation
                    mermaidString += `    ${prevStep.id} -.->|Wait: ${step.waitTime}| ${step.id}\n`;
                    const wtMatch = step.waitTime.match(/\d+(\.\d+)?/);
                    if (wtMatch) totalWaitTime += parseFloat(wtMatch[0]);
                }
            }

            const leadTime = totalProcessTime + totalWaitTime;
            const flowEfficiency = leadTime > 0 ? Math.round((totalProcessTime / leadTime) * 100) : 0;
            mermaidString += `\n    %% Add process metrics\n`;
            mermaidString += `    subgraph Metrics\n`;
            mermaidString += `        PT[Process Time: ${totalProcessTime.toFixed(1)} units]\n`; // .toFixed(1) for consistency
            mermaidString += `        LT[Lead Time: ${leadTime.toFixed(1)} units]\n`;
            mermaidString += `        FE[Flow Efficiency: ${flowEfficiency}%]\n`;
            mermaidString += `    end\n`;
            console.log("Mermaid code generation complete.");
            return mermaidString;
        }


        /**
          * Handles the form submission: validates, generates code, updates UI.
          */
         function handleSubmit(event) {
             event.preventDefault();
             console.log("Form submitted.");
             // Reset output state
             outputContainer.style.display = 'none';
             copyButton.disabled = true; saveMarkdownBtn.disabled = true;
             copyFeedback.style.display = 'none'; saveFeedback.style.display = 'none';
             mermaidOutput.value = '';

             try {
                 const formData = getFormData();
                 if (!formData) { console.warn("Validation failed. Mermaid code not generated."); return; }
                 const mermaidCode = generateMermaidCode(formData);
                 mermaidOutput.value = mermaidCode;
                 outputContainer.style.display = 'block';
                 copyButton.disabled = false; saveMarkdownBtn.disabled = false;
                 console.log("Mermaid code generated and displayed. Output buttons enabled.");
             } catch (error) {
                 console.error("Error during form submission or Mermaid generation:", error);
                 alert("An unexpected error occurred while generating the diagram. Check the console (F12) for details.");
                 outputContainer.style.display = 'none';
             }
         }

        /**
         * Copies the generated Mermaid code from the textarea to the clipboard.
         */
        function copyToClipboard() {
             if (copyButton.disabled) return;
             mermaidOutput.select();
             mermaidOutput.setSelectionRange(0, 99999); // For mobile devices
             try {
                 navigator.clipboard.writeText(mermaidOutput.value)
                     .then(() => {
                         console.log("Mermaid code copied to clipboard via Clipboard API.");
                         copyFeedback.textContent = "Copied to clipboard!";
                         copyFeedback.className = "text-sm text-green-600 mt-2";
                         copyFeedback.style.display = 'inline';
                         saveFeedback.style.display = 'none';
                         setTimeout(() => { copyFeedback.style.display = 'none'; }, 2500);
                     })
                     .catch(err => {
                         console.error('Failed to copy using navigator.clipboard: ', err);
                         copyUsingExecCommand(); // Attempt fallback
                     });
             } catch (err) {
                  console.error('Clipboard API access error or not supported: ', err);
                  copyUsingExecCommand(); // Attempt fallback
             }
         }

        /**
         * Fallback method for copying text using the older document.execCommand.
         */
         function copyUsingExecCommand() {
             try {
                 const successful = document.execCommand('copy');
                 if (successful) {
                     console.log("Mermaid code copied to clipboard (using execCommand fallback).");
                     copyFeedback.textContent = "Copied (fallback)!";
                     copyFeedback.className = "text-sm text-green-600 mt-2";
                     copyFeedback.style.display = 'inline';
                     saveFeedback.style.display = 'none';
                     setTimeout(() => { copyFeedback.style.display = 'none'; }, 2500);
                 } else {
                     console.error('execCommand fallback failed to copy.');
                     copyFeedback.textContent = "Copy failed. Please copy manually.";
                     copyFeedback.className = "text-sm text-red-600 mt-2";
                     copyFeedback.style.display = 'inline';
                     setTimeout(() => { copyFeedback.style.display = 'none'; }, 3000);
                 }
             } catch (execErr) {
                 console.error('execCommand fallback failed with error: ', execErr);
                 copyFeedback.textContent = "Copy failed. Please copy manually.";
                 copyFeedback.className = "text-sm text-red-600 mt-2";
                 copyFeedback.style.display = 'inline';
                 setTimeout(() => { copyFeedback.style.display = 'none'; }, 3000);
             }
         }

        /**
         * Pads a single-digit number with a leading zero.
         */
        function padZero(num) { return num < 10 ? '0' + num : num.toString(); }

        /**
         * Generates a filename for the Markdown file.
         */
        function getMarkdownFilename(title) {
            const trimmedTitle = title.trim();
            if (trimmedTitle) {
                const sanitized = trimmedTitle.replace(/\s+/g, '_').replace(/[\\/:*?"<>|#%&{}]/g, '');
                return (sanitized ? `${sanitized}` : `vsm_diagram_${Date.now()}`) + ".md";
            } else {
                const now = new Date();
                return `vsm_${padZero(now.getMonth() + 1)}${padZero(now.getDate())}_${padZero(now.getHours())}${padZero(now.getMinutes())}${padZero(now.getSeconds())}.md`;
            }
        }

        /**
         * Generates the full Markdown content string.
         */
        function generateMarkdownContent(title, mermaidCode, filename) {
            const displayTitle = title.trim() || filename.replace('.md', '').replace(/_/g, ' ');
            return `# ${displayTitle}\n\nHere is the visual representation of our process flow:\n\n\`\`\`mermaid\n${mermaidCode.trimEnd()}\n\`\`\`\n\n*Generated by VSM Mermaid Generator*`;
        }

        /**
         * Creates a Blob and triggers a browser download for the given content.
         */
        function downloadFile(filename, content) {
            try {
                const blob = new Blob([content], { type: 'text/markdown;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                console.log(`Markdown file download initiated as: ${filename}`);
                saveFeedback.textContent = `Saved as ${filename}`;
                saveFeedback.className = "text-sm text-sky-600 mt-2";
                saveFeedback.style.display = 'inline';
                copyFeedback.style.display = 'none';
                setTimeout(() => { saveFeedback.style.display = 'none'; }, 3000);

            } catch(error) {
                 console.error("Error triggering file download:", error);
                 saveFeedback.textContent = "Save failed. Please try copying code.";
                 saveFeedback.className = "text-sm text-red-600 mt-2";
                 saveFeedback.style.display = 'inline';
                 setTimeout(() => { saveFeedback.style.display = 'none'; }, 3000);
            }
        }

        /**
         * Handles the click event for the "Save as Markdown" button.
         */
        function handleSaveMarkdown() {
            if (saveMarkdownBtn.disabled) return;
            console.log("Save as Markdown button clicked.");
            const mermaidCode = mermaidOutput.value;
            if (!mermaidCode || mermaidCode.startsWith("graph LR\n    %% No steps entered")) {
                alert("Please generate valid Mermaid code first before saving.");
                return;
            }
            const title = titleInput.value;
            const filename = getMarkdownFilename(title);
            const markdownContent = generateMarkdownContent(title, mermaidCode, filename);
            downloadFile(filename, markdownContent);
        }


        // --- Event Listeners Setup ---
        addStepEndBtn.addEventListener('click', addStepAtEnd);
        form.addEventListener('submit', handleSubmit);
        copyButton.addEventListener('click', copyToClipboard);
        saveMarkdownBtn.addEventListener('click', handleSaveMarkdown);

        // --- Initial Page Setup ---
        console.log("Initializing page: adding first step and disabling output buttons.");
        addNewStep(); // Add the first step by default when the page loads
        copyButton.disabled = true;
        saveMarkdownBtn.disabled = true;

        // --- SCRIPT END ---
    </script>
</body>
</html>